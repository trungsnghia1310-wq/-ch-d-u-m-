<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>ƒê·∫ø Ch·∫ø D·∫ßu ƒêen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card: #020617;
      --card2: #020617;
      --accent: #f97316;
      --accent-soft: rgba(249,115,22,0.15);
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .app {
      width: 100%;
      max-width: 420px;
      padding: 24px 16px 32px;
    }
    .card {
      background: radial-gradient(circle at top left, #111827 0, #020617 60%);
      border-radius: 20px;
      padding: 16px 18px 18px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.17);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0 0, rgba(249,115,22,0.22), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(59,130,246,0.14), transparent 55%);
      opacity: 0.55;
      pointer-events: none;
    }
    .card-inner {
      position: relative;
      z-index: 1;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 span.icon {
      font-size: 18px;
    }
    .subtitle {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pill-online {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 8px 3px 4px;
      font-size: 11px;
      background: rgba(22,163,74,0.08);
      border: 1px solid rgba(22,163,74,0.3);
      color: #bbf7d0;
    }
    .pill-online-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4ade80;
      box-shadow: 0 0 0 4px rgba(22,163,74,0.3);
    }
    .section-title {
      margin: 14px 0 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }
    .wallet-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(31,41,55,0.9);
      margin-bottom: 6px;
      font-size: 13px;
    }
    .wallet-label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--muted);
    }
    .pill {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.85);
    }
    .pill-strong {
      border-color: rgba(249,115,22,0.5);
      background: rgba(249,115,22,0.1);
      color: #fed7aa;
    }
    .section-box {
      margin-top: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(75,85,99,0.7);
      background: linear-gradient(
        to bottom right,
        rgba(15,23,42,0.96),
        rgba(15,23,42,1)
      );
      padding: 10px 10px 12px;
    }
    .section-box p {
      margin: 0 0 6px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }
    .field-label {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      margin-bottom: 3px;
    }
    .input, .select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.96);
      color: var(--text);
      font-size: 13px;
      padding: 7px 9px;
      outline: none;
    }
    .input:focus, .select:focus {
      border-color: rgba(249,115,22,0.8);
      box-shadow: 0 0 0 1px rgba(249,115,22,0.3);
    }
    .btn {
      width: 100%;
      margin-top: 10px;
      border-radius: 999px;
      padding: 9px 14px;
      border: none;
      outline: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .btn-primary {
      background: linear-gradient(to right, #f97316, #fb923c);
      color: #111827;
      box-shadow:
        0 10px 30px rgba(248,113,113,0.35),
        0 0 0 1px rgba(248,250,252,0.08);
    }
    .btn-outline {
      background: transparent;
      color: #f97316;
      border: 1px solid rgba(249,115,22,0.7);
    }
    .history {
      margin-top: 10px;
      border-top: 1px solid rgba(31,41,55,0.9);
      padding-top: 8px;
    }
    .history-empty {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      font-size: 11px;
      border-bottom: 1px dashed rgba(31,41,55,0.8);
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
    }
    .tag-pending {
      background: rgba(250,204,21,0.15);
      color: #facc15;
      border: 1px solid rgba(250,204,21,0.4);
    }
    .tag-done {
      background: rgba(34,197,94,0.15);
      color: #bbf7d0;
      border: 1px solid rgba(34,197,94,0.5);
    }
    .tag-reject {
      background: rgba(248,113,113,0.12);
      color: #fecaca;
      border: 1px solid rgba(248,113,113,0.5);
    }

    /* bottom nav */
    .bottom-nav-wrap {
      margin-top: 18px;
      display: flex;
      justify-content: center;
    }
    .bottom-nav {
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      padding: 4px 6px;
      display: inline-flex;
      gap: 4px;
      border: 1px solid rgba(31,41,55,1);
      box-shadow: 0 16px 35px rgba(15,23,42,0.9);
      font-size: 11px;
    }
    .nav-btn {
      border-radius: 999px;
      padding: 4px 11px;
      border: none;
      background: transparent;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .nav-btn.active {
      background: rgba(249,115,22,0.18);
      color: #fed7aa;
    }

    .error {
      margin-top: 6px;
      font-size: 11px;
      color: var(--danger);
    }
    .success {
      margin-top: 6px;
      font-size: 11px;
      color: var(--success);
    }

    .row-2col {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .row-2col .input {
      font-size: 12px;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="card-inner">
      <h1>
        <span class="icon">üõ¢</span>
        <span>ƒê·∫ø Ch·∫ø D·∫ßu ƒêen</span>
      </h1>
      <div class="subtitle">
        <span id="user-label">@user ‚Ä¢ ID: <span id="user-id">demo</span></span>
        <span class="pill-online">
          <span class="pill-online-dot"></span>
          Online
        </span>
      </div>

      <!-- V√ç & GI√Å TR·ªä -->
      <div class="section-title">V√≠ & t√†i s·∫£n</div>
      <div class="wallet-row">
        <div class="wallet-label">
          <span>üõ¢ D·∫ßu hi·ªán c√≥</span>
        </div>
        <span class="pill-strong"><span id="oil-amount">0.0</span> th√πng</span>
      </div>
      <div class="wallet-row">
        <div class="wallet-label">
          <span>üí∞ Xu hi·ªán c√≥</span>
        </div>
        <span class="pill"><span id="xu-amount">0</span> Xu</span>
      </div>
      <div class="wallet-row">
        <div class="wallet-label">
          <span>‚õè C·∫•p m√°y b∆°m</span>
        </div>
        <span class="pill">
          Lv. <span id="pump-level">1</span> ‚Ä¢
          <span id="pump-speed">1.0</span> d·∫ßu/nh·∫•p
        </span>
      </div>

      <!-- ƒê√ÄO D·∫¶U & N√ÇNG C·∫§P -->
      <div class="section-box">
        <p>
          M·ªói l·∫ßn b·∫•m <strong>ƒê√†o d·∫ßu</strong> b·∫°n nh·∫≠n ƒë∆∞·ª£c s·ªë d·∫ßu t∆∞∆°ng ·ª©ng v·ªõi
          <strong>t·ªëc ƒë·ªô b∆°m</strong>. C√≥ th·ªÉ ƒë·ªïi D·∫ßu & n√¢ng c·∫•p m√°y b∆°m b·∫±ng Xu.
        </p>

        <div class="row-2col">
          <button class="btn btn-primary" id="btn-mine">
            ‚õè ƒê√†o d·∫ßu
          </button>
          <button class="btn btn-outline" id="btn-convert">
            üîÅ ƒê·ªïi 10 d·∫ßu ‚Üí 10 Xu
          </button>
        </div>

        <div class="field-label">N√¢ng c·∫•p m√°y b∆°m</div>
        <div class="row-2col">
          <input
            id="upgrade-cost"
            class="input"
            type="text"
            value=""
            disabled
          />
          <button class="btn btn-outline" id="btn-upgrade">
            ‚öôÔ∏è N√¢ng c·∫•p
          </button>
        </div>
      </div>

      <!-- R√öT TI·ªÄN -->
      <div class="section-box" style="margin-top: 12px;">
        <p>
          R√∫t ti·ªÅn th·∫≠t: 10 Xu = 1.000ƒë. Min r√∫t: 200 Xu.
          S·ªë Xu b·ªã tr·ª´ kh·ªèi v√≠ v√† t·∫°o y√™u c·∫ßu r√∫t v·ªÅ backend Telegram c·ªßa b·∫°n.
        </p>

        <div class="field-label">S·ªë Xu mu·ªën r√∫t</div>
        <input id="withdraw-amount" class="input" type="number" value="200" min="200" step="10" />

        <div class="field-label">S·ªë ƒëi·ªán tho·∫°i (Momo / Ng√¢n h√†ng)</div>
        <input id="withdraw-phone" class="input" type="tel" placeholder="84xxxxxxxxx" />

        <button class="btn btn-primary" id="btn-withdraw">
          üí∏ G·ª≠i y√™u c·∫ßu r√∫t (backend th·∫≠t)
        </button>

        <div id="withdraw-msg"></div>

        <div class="history" id="history">
          <div class="history-empty">Ch∆∞a c√≥ y√™u c·∫ßu r√∫t n√†o.</div>
        </div>
      </div>

      <div class="bottom-nav-wrap">
        <div class="bottom-nav">
          <button class="nav-btn">
            <span>üè†</span> Trang
          </button>
          <button class="nav-btn">
            <span>üìú</span> Nhi·ªám v·ª•
          </button>
          <button class="nav-btn">
            <span>üë•</span> B·∫°n b√®
          </button>
          <button class="nav-btn active">
            <span>üíº</span> V√≠
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ======= L·∫§Y TH√îNG TIN USER TELEGRAM / DEMO =======
  const tg = window.Telegram?.WebApp;
  let tgId = "demo-user-1";
  let username = "demo";

  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
    const u = tg.initDataUnsafe.user;
    tgId = String(u.id);
    username = u.username || u.first_name || "user";
  }

  document.getElementById("user-id").textContent = tgId;
  document.getElementById("user-label").textContent = "@" + username + " ‚Ä¢ ID: " + tgId;

  // ======= STATE TRONG FRONTEND =======
  const state = {
    tg_id: tgId,
    username: username,
    xu: 0,
    oil: 0,
    pump_level: 1,
    pump_speed: 1.0,
  };

  const els = {
    oil: document.getElementById("oil-amount"),
    xu: document.getElementById("xu-amount"),
    pumpLevel: document.getElementById("pump-level"),
    pumpSpeed: document.getElementById("pump-speed"),
    upgradeCost: document.getElementById("upgrade-cost"),
    withdrawMsg: document.getElementById("withdraw-msg"),
    history: document.getElementById("history"),
  };

  function calcUpgradeCost() {
    // v√≠ d·ª•: base 50 Xu * level
    return 50 * state.pump_level;
  }

  function renderState() {
    els.oil.textContent = state.oil.toFixed(1);
    els.xu.textContent = state.xu.toString();
    els.pumpLevel.textContent = state.pump_level.toString();
    els.pumpSpeed.textContent = state.pump_speed.toFixed(1);
    els.upgradeCost.value = `N√¢ng c·∫•p Lv.${state.pump_level + 1} (t·ªën ${calcUpgradeCost()} Xu)`;
  }

  renderState();

  // ======= CALL API HELPER =======
  async function apiGet(path) {
    const res = await fetch(path);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || res.statusText);
    }
    return res.json();
  }

  async function apiPost(path, data) {
    const res = await fetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || res.statusText);
    }
    return res.json();
  }

  function showMessage(type, text) {
    els.withdrawMsg.innerHTML = "";
    if (!text) return;
    const div = document.createElement("div");
    div.className = type === "error" ? "error" : "success";
    div.textContent = text;
    els.withdrawMsg.appendChild(div);
  }

  // ======= LOAD STATE T·ª™ BACKEND =======
  async function loadBackendState() {
    try {
      const data = await apiGet(`/api/player/state?tg_id=${encodeURIComponent(tgId)}`);
      state.xu = data.xu;
      state.oil = data.oil;
      state.pump_level = data.pump_level;
      state.pump_speed = data.pump_speed;
      renderState();
    } catch (e) {
      console.warn("Kh√¥ng load ƒë∆∞·ª£c state backend:", e);
    }
  }

  async function saveBackendState() {
    try {
      await apiPost("/api/player/state", {
        tg_id: state.tg_id,
        username: state.username,
        xu: state.xu,
        oil: state.oil,
        pump_level: state.pump_level,
        pump_speed: state.pump_speed,
      });
    } catch (e) {
      console.warn("L·ªói save state:", e);
    }
  }

  // ======= ƒê√ÄO D·∫¶U / ƒê·ªîI D·∫¶U / N√ÇNG C·∫§P =======
  document.getElementById("btn-mine").addEventListener("click", async () => {
    state.oil += state.pump_speed;
    renderState();
    await saveBackendState();
  });

  document.getElementById("btn-convert").addEventListener("click", async () => {
    const need = 10;
    if (state.oil < need) {
      showMessage("error", "Kh√¥ng ƒë·ªß d·∫ßu ƒë·ªÉ ƒë·ªïi (c·∫ßn ‚â• 10 th√πng).");
      return;
    }
    state.oil -= need;
    state.xu += 10;
    renderState();
    await saveBackendState();
    showMessage("success", "ƒê√£ ƒë·ªïi 10 d·∫ßu l·∫•y 10 Xu.");
  });

  document.getElementById("btn-upgrade").addEventListener("click", async () => {
    const cost = calcUpgradeCost();
    if (state.xu < cost) {
      showMessage("error", `Kh√¥ng ƒë·ªß Xu ƒë·ªÉ n√¢ng c·∫•p (c·∫ßn ${cost} Xu).`);
      return;
    }
    state.xu -= cost;
    state.pump_level += 1;
    state.pump_speed = Number((state.pump_speed * 1.25).toFixed(1));
    renderState();
    await saveBackendState();
    showMessage("success", "N√¢ng c·∫•p m√°y b∆°m th√†nh c√¥ng!");
  });

  // ======= R√öT TI·ªÄN =======
  async function loadWithdrawHistory() {
    try {
      const list = await apiGet(`/api/withdraw-history?tg_id=${encodeURIComponent(tgId)}`);
      els.history.innerHTML = "";
      if (!list.length) {
        const div = document.createElement("div");
        div.className = "history-empty";
        div.textContent = "Ch∆∞a c√≥ y√™u c·∫ßu r√∫t n√†o.";
        els.history.appendChild(div);
        return;
      }
      list.forEach((item) => {
        const row = document.createElement("div");
        row.className = "history-item";

        const left = document.createElement("div");
        left.textContent = `${item.amount_xu} Xu ‚Ä¢ ${item.phone}`;

        const right = document.createElement("div");
        const tag = document.createElement("span");
        tag.classList.add("tag");
        if (item.status === "pending") {
          tag.classList.add("tag-pending");
          tag.textContent = "Ch·ªù duy·ªát";
        } else if (item.status === "done") {
          tag.classList.add("tag-done");
          tag.textContent = "Ho√†n t·∫•t";
        } else {
          tag.classList.add("tag-reject");
          tag.textContent = item.status || "T·ª´ ch·ªëi";
        }
        right.appendChild(tag);
        row.appendChild(left);
        row.appendChild(right);
        els.history.appendChild(row);
      });
    } catch (e) {
      console.warn("Kh√¥ng load ƒë∆∞·ª£c l·ªãch s·ª≠ r√∫t:", e);
    }
  }

  document.getElementById("btn-withdraw").addEventListener("click", async () => {
    showMessage("", "");
    const amountInput = document.getElementById("withdraw-amount");
    const phoneInput = document.getElementById("withdraw-phone");
    const amount = Number(amountInput.value || "0");
    const phone = (phoneInput.value || "").trim();

    if (!amount || amount < 200) {
      showMessage("error", "Min r√∫t l√† 200 Xu.");
      return;
    }
    if (!phone.startsWith("84")) {
      showMessage("error", "S·ªë ƒëi·ªán tho·∫°i ph·∫£i d·∫°ng 84xxxxxxxxx.");
      return;
    }
    if (state.xu < amount) {
      showMessage("error", "B·∫°n kh√¥ng ƒë·ªß Xu ƒë·ªÉ r√∫t.");
      return;
    }

    try {
      // tr·ª´ Xu trong v√≠ tr∆∞·ªõc (demo logic, backend Telegram x·ª≠ l√Ω ti·ªÅn th·∫≠t sau)
      state.xu -= amount;
      renderState();
      await saveBackendState();

      await apiPost("/api/withdraw", {
        tg_id: state.tg_id,
        username: state.username,
        amount_xu: amount,
        phone: phone,
      });

      showMessage("success", "ƒê√£ g·ª≠i y√™u c·∫ßu r√∫t, vui l√≤ng ƒë·ª£i admin duy·ªát.");
      await loadWithdrawHistory();
    } catch (e) {
      console.error(e);
      showMessage("error", "L·ªói g·ª≠i y√™u c·∫ßu r√∫t. Th·ª≠ l·∫°i sau.");
    }
  });

  // ======= INIT =======
  (async () => {
    await loadBackendState();
    renderState();
    await loadWithdrawHistory();
  })();
</script>
</body>
</html>