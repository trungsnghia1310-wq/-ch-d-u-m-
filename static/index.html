<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ƒê·∫ø Ch·∫ø D·∫ßu ƒêen ‚Äì V√≠ & R√∫t ti·ªÅn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050816;
        --card: #101827;
        --accent: #f97316;
        --accent-soft: rgba(249, 115, 22, 0.1);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --danger: #f87171;
        --success: #4ade80;
        --border: #1f2937;
      }

      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display",
          "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #111827, #020617);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .app {
        width: 100%;
        max-width: 480px;
        padding: 16px;
      }

      .card {
        background: rgba(15, 23, 42, 0.95);
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
        padding: 16px 18px 20px;
        backdrop-filter: blur(18px);
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-icon {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #fed7aa, #f97316);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        box-shadow: 0 0 18px rgba(248, 250, 252, 0.35);
      }

      .title-text {
        font-weight: 650;
        letter-spacing: 0.03em;
        font-size: 15px;
      }

      .user-small {
        text-align: right;
        font-size: 11px;
        color: var(--muted);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.24);
        gap: 5px;
      }

      .pill-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
      }

      .section-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .wallet-row {
        display: flex;
        justify-content: space-between;
        background: rgba(15, 23, 42, 0.85);
        border-radius: 12px;
        padding: 8px 10px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        margin-bottom: 4px;
        font-size: 13px;
      }

      .wallet-row span:first-child {
        color: var(--muted);
      }

      .wallet-row span:last-child {
        font-weight: 600;
      }

      .divider {
        border: none;
        border-top: 1px dashed rgba(55, 65, 81, 0.85);
        margin: 12px 0;
      }

      .subtext {
        font-size: 11px;
        color: var(--muted);
        line-height: 1.4;
      }

      .hint {
        font-size: 11px;
        color: var(--muted);
        margin-top: 4px;
      }

      .bounty {
        color: var(--accent);
        font-weight: 600;
      }

      .field {
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .field-label {
        font-size: 12px;
        margin-bottom: 4px;
        color: var(--muted);
      }

      .input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.96);
        color: var(--text);
        font-size: 13px;
        outline: none;
      }

      .input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.6);
      }

      .btn {
        width: 100%;
        border-radius: 999px;
        padding: 9px 10px;
        border: none;
        outline: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 6px;
        background: linear-gradient(135deg, #f97316, #fb923c);
        color: #0b1120;
        box-shadow: 0 14px 32px rgba(249, 115, 22, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      .btn span {
        font-size: 13px;
      }

      .status {
        margin-top: 8px;
        font-size: 12px;
      }

      .status.error {
        color: var(--danger);
      }

      .status.success {
        color: var(--success);
      }

      .history-title {
        margin-top: 10px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--muted);
      }

      .history-list {
        margin-top: 4px;
        max-height: 180px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .history-item {
        padding: 7px 8px;
        border-radius: 10px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(15, 23, 42, 0.9);
        font-size: 12px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 4px;
      }

      .history-top {
        display: flex;
        justify-content: space-between;
      }

      .tag {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .tag.pending {
        border-color: #f97316;
        color: #fed7aa;
      }

      .tag.done {
        border-color: #4ade80;
        color: #bbf7d0;
      }

      .tag.reject {
        border-color: #fca5a5;
        color: #fecaca;
      }

      .history-meta {
        color: var(--muted);
        font-size: 11px;
      }

      .bottom-nav {
        margin-top: 16px;
        display: flex;
        justify-content: center;
        gap: 8px;
        font-size: 11px;
        color: var(--muted);
        opacity: 0.7;
      }

      .bottom-nav span.active {
        color: var(--accent);
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <div class="card-header">
          <div class="title">
            <div class="title-icon">‚õΩ</div>
            <div>
              <div class="title-text">ƒê·∫ø Ch·∫ø D·∫ßu ƒêen</div>
              <div class="subtext" id="user-label">ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi ch∆°i...</div>
            </div>
          </div>
          <div class="user-small">
            <div class="pill">
              <span class="pill-dot"></span>
              <span id="pill-status">Online</span>
            </div>
          </div>
        </div>

        <!-- V√≠ hi·ªán c√≥ -->
        <div class="section-title">V√≠ & gi√° tr·ªã xu</div>
        <div class="wallet-row">
          <span>ƒê·∫ßu hi·ªán c√≥</span>
          <span id="wallet-balance">0,0</span>
        </div>
        <div class="wallet-row">
          <span>Gi√° tr·ªã Xu</span>
          <span id="wallet-value">0 VND</span>
        </div>

        <hr class="divider" />

        <!-- R√∫t ti·ªÅn -->
        <div class="section-title">R√∫t ti·ªÅn</div>
        <div class="subtext">
          * Quy ∆∞·ªõc: 10 Xu = 1.000ƒë. ƒê·ªÅ xu·∫•t min r√∫t: 200 Xu = 20.000ƒë.  
          * S·ªë Xu s·∫Ω do bot Telegram c·ªßa b·∫°n quy·∫øt ƒë·ªãnh & tr·ª´ ·ªü backend th·∫≠t.
        </div>

        <div class="field">
          <div class="field-label">S·ªë Xu mu·ªën r√∫t</div>
          <input
            type="number"
            id="withdraw-amount"
            class="input"
            placeholder="V√≠ d·ª•: 200"
            min="200"
            step="10"
          />
          <div class="hint">T·ªëi thi·ªÉu 200 Xu. S·ªë Xu n√†y s·∫Ω g·ª≠i l√™n backend.</div>
        </div>

        <div class="field">
          <div class="field-label">S·ªë ƒëi·ªán tho·∫°i (Momo / ng√¢n h√†ng)</div>
          <input
            type="tel"
            id="withdraw-phone"
            class="input"
            placeholder="84xxxxxxxxx"
          />
          <div class="hint">B·∫Øt bu·ªôc d·∫°ng 84xxxxxxxxx (kh√¥ng c√≥ s·ªë 0 ·ªü ƒë·∫ßu).</div>
        </div>

        <button id="withdraw-btn" class="btn">
          <span>G·ª≠i y√™u c·∫ßu r√∫t (backend th·∫≠t)</span>
        </button>

        <div id="withdraw-status" class="status"></div>

        <div class="history-title">L·ªãch s·ª≠ y√™u c·∫ßu r√∫t g·∫ßn ƒë√¢y</div>
        <div id="withdraw-history" class="history-list">
          <div class="subtext">
            Ch∆∞a c√≥ y√™u c·∫ßu n√†o. Khi b·∫°n r√∫t, l·ªãch s·ª≠ s·∫Ω hi·ªán ·ªü ƒë√¢y.
          </div>
        </div>
      </div>

      <div class="bottom-nav">
        <span>üè† Trang</span>
        <span>Nhi·ªám v·ª•</span>
        <span>D·∫ßu</span>
        <span>B·∫°n b√®</span>
        <span class="active">V√≠</span>
      </div>
    </div>

    <script>
      // ===================== Telegram user info =====================
      const tg = window.Telegram ? window.Telegram.WebApp : null;
      let TG_ID = "0";
      let TG_USERNAME = "";

      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        const user = tg.initDataUnsafe.user;
        TG_ID = String(user.id);
        TG_USERNAME = user.username || "";
        document.getElementById(
          "user-label"
        ).textContent = `@${TG_USERNAME || "user"} ¬∑ ID: ${TG_ID}`;
      } else {
        document.getElementById("user-label").textContent =
          "Kh√¥ng l·∫•y ƒë∆∞·ª£c info Telegram ‚Äì ƒëang ch·∫°y ·ªü tr√¨nh duy·ªát th∆∞·ªùng";
      }

      // ===================== Helper =====================

      function formatTime(ts) {
        const d = new Date(ts * 1000);
        const pad = (n) => String(n).padStart(2, "0");
        return `${pad(d.getDate())}/${pad(
          d.getMonth() + 1
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function setStatus(msg, type) {
        const el = document.getElementById("withdraw-status");
        el.textContent = msg;
        el.className = "status " + (type || "");
      }

      // ===================== Call backend =====================

      async function sendWithdrawRequest() {
        const amountEl = document.getElementById("withdraw-amount");
        const phoneEl = document.getElementById("withdraw-phone");
        const btn = document.getElementById("withdraw-btn");

        const amount = parseInt(amountEl.value || "0", 10);
        const phone = phoneEl.value.trim();

        if (!TG_ID || TG_ID === "0") {
          setStatus(
            "Kh√¥ng l·∫•y ƒë∆∞·ª£c Telegram ID. H√£y m·ªü WebApp t·ª´ trong Telegram.",
            "error"
          );
          return;
        }

        if (isNaN(amount) || amount < 200) {
          setStatus("Min r√∫t l√† 200 Xu.", "error");
          return;
        }

        if (!phone.startsWith("84") || phone.length < 9) {
          setStatus("S·ªë ƒëi·ªán tho·∫°i ph·∫£i d·∫°ng 84xxxxxxxxx.", "error");
          return;
        }

        btn.disabled = true;
        setStatus("ƒêang g·ª≠i y√™u c·∫ßu r√∫t...", "");

        try {
          const res = await fetch("/api/withdraw", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              tg_id: TG_ID,
              username: TG_USERNAME,
              amount_xu: amount,
              phone: phone,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            setStatus(data.detail || "C√≥ l·ªói x·∫£y ra khi g·ª≠i y√™u c·∫ßu.", "error");
          } else {
            setStatus(
              `ƒê√£ t·∫°o y√™u c·∫ßu #${data.id} ¬∑ ${data.amount_xu} Xu ¬∑ ${data.phone}`,
              "success"
            );
            amountEl.value = "";
            // reload history
            loadHistory();
          }
        } catch (e) {
          console.error(e);
          setStatus("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server. Th·ª≠ l·∫°i sau.", "error");
        } finally {
          btn.disabled = false;
        }
      }

      async function loadHistory() {
        if (!TG_ID || TG_ID === "0") return;

        const box = document.getElementById("withdraw-history");
        box.innerHTML =
          '<div class="subtext">ƒêang t·∫£i l·ªãch s·ª≠ r√∫t...</div>';

        try {
          const res = await fetch(
            `/api/withdraw-history?tg_id=${encodeURIComponent(TG_ID)}`
          );
          const data = await res.json();

          if (!Array.isArray(data) || data.length === 0) {
            box.innerHTML =
              '<div class="subtext">Ch∆∞a c√≥ y√™u c·∫ßu r√∫t n√†o.</div>';
            return;
          }

          box.innerHTML = "";
          for (const item of data) {
            const div = document.createElement("div");
            div.className = "history-item";

            const status = item.status || "pending";
            let tagClass = "pending";
            let tagText = "Pending";
            if (status === "done" || status === "paid") {
              tagClass = "done";
              tagText = "Ho√†n t·∫•t";
            } else if (status === "reject" || status === "rejected") {
              tagClass = "reject";
              tagText = "T·ª´ ch·ªëi";
            }

            div.innerHTML = `
              <div class="history-top">
                <div><b>#${item.id}</b> ¬∑ ${item.amount_xu} Xu</div>
                <div class="tag ${tagClass}">${tagText}</div>
              </div>
              <div class="history-meta">SƒêT: ${item.phone}</div>
              <div class="history-meta">L√∫c: ${formatTime(item.created_at)}</div>
            `;
            box.appendChild(div);
          }
        } catch (e) {
          console.error(e);
          box.innerHTML =
            '<div class="subtext">L·ªói t·∫£i l·ªãch s·ª≠. Th·ª≠ l·∫°i sau.</div>';
        }
      }

      // ===================== Init =====================

      document
        .getElementById("withdraw-btn")
        .addEventListener("click", sendWithdrawRequest);

      // load history khi v√†o trang
      loadHistory();
    </script>
  </body>
</html>