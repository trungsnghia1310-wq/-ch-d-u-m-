<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>ƒê·∫ø Ch·∫ø D·∫ßu ƒêen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --bg-soft: #020617;
        --card: #020617;
        --card-soft: #020617;
        --border: #1e293b;
        --accent: #f97316;
        --accent-soft: rgba(249, 115, 22, 0.12);
        --accent-strong: #f97316;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --danger: #f87171;
        --success: #4ade80;
      }

      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #020617, #020617);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: 8px;
      }

      .app {
        width: 100%;
        max-width: 480px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card {
        background: rgba(15, 23, 42, 0.96);
        border-radius: 18px;
        border: 1px solid rgba(30, 64, 175, 0.5);
        padding: 12px 14px 12px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-circle {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        background: radial-gradient(circle at 25% 20%, #fed7aa, #f97316);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 22px rgba(248, 250, 252, 0.35);
        font-size: 14px;
      }

      .title-block {
        display: flex;
        flex-direction: column;
      }

      .title-main {
        font-size: 15px;
        font-weight: 650;
        letter-spacing: 0.04em;
      }

      .title-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .online-pill {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        background: rgba(15, 23, 42, 0.9);
        font-size: 11px;
      }

      .online-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 14px rgba(34, 197, 94, 0.9);
      }

      .nav-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
      }

      .nav-tab {
        flex: 1;
        font-size: 12px;
        padding: 6px 4px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.95);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
        text-align: center;
        cursor: pointer;
      }

      .nav-tab.active {
        color: #020617;
        background: linear-gradient(135deg, #f97316, #fb923c);
        border-color: rgba(248, 250, 252, 0.4);
        box-shadow: 0 10px 28px rgba(249, 115, 22, 0.5);
        font-weight: 600;
      }

      .section-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.18em;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
      }

      .stat-card {
        border-radius: 12px;
        border: 1px solid rgba(30, 64, 175, 0.6);
        background: radial-gradient(circle at top left, #0f172a, #020617);
        padding: 8px 9px;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .stat-label {
        color: var(--muted);
        font-size: 11px;
      }

      .stat-value {
        font-size: 14px;
        font-weight: 600;
      }

      .stat-sub {
        font-size: 11px;
        color: var(--muted);
      }

      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      .rig-card {
        border-radius: 14px;
        border: 1px solid rgba(30, 64, 175, 0.7);
        background: radial-gradient(circle at top, #020617, #020617);
        padding: 10px 10px 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .rig-top {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
      }

      .rig-top span strong {
        color: var(--accent);
      }

      .rig-image-box {
        width: 100%;
        background: radial-gradient(circle at top, #020617, #020617);
        border-radius: 12px;
        border: 1px solid rgba(30, 64, 175, 0.8);
        padding: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .rig-image-box img {
        max-width: 100%;
        height: auto;
        display: block;
      }

      .cooldown-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 12px;
      }

      .cooldown-label {
        color: var(--muted);
      }

      .cooldown-time {
        font-variant-numeric: tabular-nums;
      }

      .cooldown-bar {
        margin-top: 4px;
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        overflow: hidden;
        border: 1px solid rgba(30, 64, 175, 0.8);
      }

      .cooldown-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #f97316);
        transition: width 0.2s linear;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
        padding: 8px 10px;
        border-radius: 999px;
        border: none;
        outline: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 600;
        margin-top: 6px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #f97316, #fb923c);
        color: #020617;
        box-shadow: 0 12px 30px rgba(249, 115, 22, 0.55);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      .btn-secondary {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }

      .btn-secondary:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .small-text {
        font-size: 11px;
        color: var(--muted);
      }

      .mb-4 {
        margin-bottom: 8px;
      }

      .field {
        margin-bottom: 6px;
      }

      .field-label {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 3px;
      }

      .input {
        width: 100%;
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid rgba(51, 65, 85, 0.95);
        background: rgba(15, 23, 42, 0.96);
        color: var(--text);
        font-size: 13px;
        outline: none;
      }

      .input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(249, 115, 22, 0.5);
      }

      .status {
        font-size: 11px;
        margin-top: 4px;
      }

      .status.error {
        color: var(--danger);
      }

      .status.success {
        color: var(--success);
      }

      .history-list {
        margin-top: 6px;
        max-height: 180px;
        overflow-y: auto;
        padding-right: 2px;
      }

      .history-item {
        border-radius: 10px;
        border: 1px solid rgba(30, 64, 175, 0.7);
        background: rgba(15, 23, 42, 0.96);
        padding: 6px 7px;
        font-size: 11px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-bottom: 4px;
      }

      .history-top {
        display: flex;
        justify-content: space-between;
      }

      .tag {
        padding: 1px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .tag.pending {
        border-color: #f97316;
        color: #fed7aa;
      }

      .tag.done {
        border-color: #4ade80;
        color: #bbf7d0;
      }

      .tag.reject {
        border-color: #fca5a5;
        color: #fecaca;
      }

      .history-meta {
        color: var(--muted);
      }

      .muted-box {
        border-radius: 12px;
        border: 1px dashed rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.9);
        padding: 8px 9px;
        font-size: 11px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <!-- HEADER -->
        <div class="header">
          <div class="header-left">
            <div class="logo-circle">‚õΩ</div>
            <div class="title-block">
              <div class="title-main">ƒê·∫ø Ch·∫ø D·∫ßu ƒêen</div>
              <div id="user-label" class="title-sub">
                ƒêang l·∫•y th√¥ng tin Telegram...
              </div>
            </div>
          </div>
          <div class="online-pill">
            <span class="online-dot"></span>
            <span>Online</span>
          </div>
        </div>

        <!-- TABS -->
        <div class="nav-tabs">
          <div class="nav-tab active" data-screen="home">Trang</div>
          <div class="nav-tab" data-screen="tasks">Nhi·ªám v·ª•</div>
          <div class="nav-tab" data-screen="oil">D·∫ßu</div>
          <div class="nav-tab" data-screen="friends">B·∫°n b√®</div>
          <div class="nav-tab" data-screen="wallet">V√≠</div>
        </div>

        <!-- SCREENS -->
        <!-- HOME -->
        <div class="screen active" id="screen-home">
          <div class="section-title">T·ªïng quan</div>
          <div class="grid-2 mb-4">
            <div class="stat-card">
              <div class="stat-label">D·∫ßu th√¥</div>
              <div class="stat-value" id="home-oil">0</div>
              <div class="stat-sub">Nguy√™n li·ªáu ch√≠nh ƒë·ªÉ n√¢ng c·∫•p.</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Xu</div>
              <div class="stat-value" id="home-xu">0</div>
              <div class="stat-sub">10 Xu = 1.000 VND (r√∫t v·ªÅ ZaloPay).</div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">Gi√†n khoan</div>
            <div class="stat-value">
              C·∫•p <span id="home-rig-level">1</span>
            </div>
            <div class="stat-sub">
              M·ªói l·∫ßn ƒë√†o: <span id="home-rig-yield">0</span> D·∫ßu ¬∑ Cooldown
              5 ph√∫t.
            </div>
          </div>
        </div>

        <!-- TASKS -->
        <div class="screen" id="screen-tasks">
          <div class="section-title">Nhi·ªám v·ª• bonus</div>
          <div class="muted-box">
            Hi·ªán t·∫°i ph·∫ßn nhi·ªám v·ª• bonus (Onus, ATX...) v·∫´n x·ª≠ l√Ω th·ªß c√¥ng qua
            bot Telegram.  
            <br />B·∫°n c√≥ th·ªÉ gi·ªØ b·ªë c·ª•c c≈© ho·∫∑c sau n√†y m√¨nh s·∫Ω n·ªëi th√™m API
            ri√™ng cho b·∫°n.
          </div>
        </div>

        <!-- OIL (ƒê√ÄO & N√ÇNG C·∫§P) -->
        <div class="screen" id="screen-oil">
          <div class="section-title">Gi√†n khoan d·∫ßu</div>

          <div class="rig-card">
            <div class="rig-top">
              <span>Lv. <strong id="oil-rig-level">1</strong></span>
              <span>
                M·ªói l·∫ßn: <strong id="oil-rig-yield">0</strong> D·∫ßu
              </span>
            </div>

            <div class="rig-image-box">
              <img
                id="rig-image"
                src="image/rig_level1.png"
                alt="Gi√†n khoan"
              />
            </div>

            <div class="cooldown-row">
              <span class="cooldown-label">Tr·∫°ng th√°i</span>
              <span class="cooldown-time" id="cooldown-label">
                S·∫µn s√†ng ƒë√†o
              </span>
            </div>
            <div class="cooldown-bar">
              <div class="cooldown-bar-fill" id="cooldown-bar"></div>
            </div>

            <button class="btn-primary" id="btn-mine">
              ‚õè Khai th√°c d·∫ßu
            </button>

            <button class="btn-secondary" id="btn-upgrade">
              üîß N√¢ng c·∫•p gi√†n khoan
            </button>

            <div class="small-text">
              D·∫ßu hi·ªán c√≥: <span id="oil-balance">0</span> ¬∑ Xu: 
              <span id="oil-xu">0</span>
            </div>
          </div>
        </div>

        <!-- FRIENDS -->
        <div class="screen" id="screen-friends">
          <div class="section-title">M·ªùi b·∫°n b√®</div>
          <div class="muted-box">
            Ch·ª©c nƒÉng m·ªùi b·∫°n b√®, ƒë·∫øm ng√†y ho·∫°t ƒë·ªông v√† chia 5% s·∫£n l∆∞·ª£ng ƒë√†o
            s·∫Ω ƒë∆∞·ª£c n·ªëi API ri√™ng (phase sau).  
            <br />Hi·ªán t·∫°i b·∫°n c√≥ th·ªÉ gi·ªØ logic c≈© tr√™n bot ƒë·ªÉ qu·∫£n l√Ω ref.
          </div>
        </div>

        <!-- WALLET -->
        <div class="screen" id="screen-wallet">
          <div class="section-title">V√≠ & r√∫t ti·ªÅn</div>

          <div class="grid-2 mb-4">
            <div class="stat-card">
              <div class="stat-label">D·∫ßu</div>
              <div class="stat-value" id="wallet-oil">0</div>
              <div class="stat-sub">C√≥ th·ªÉ chuy·ªÉn ƒë·ªïi sang Xu sau n√†y.</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Xu</div>
              <div class="stat-value" id="wallet-xu">0</div>
              <div class="stat-sub">
                10 Xu = 1.000 VND. Min r√∫t ƒë·ªÅ xu·∫•t: 200 Xu.
              </div>
            </div>
          </div>

          <div class="field">
            <div class="field-label">S·ªë Xu mu·ªën r√∫t</div>
            <input
              id="withdraw-amount"
              type="number"
              class="input"
              placeholder="V√≠ d·ª•: 200"
              min="200"
              step="10"
            />
          </div>
          <div class="field">
            <div class="field-label">S·ªë ƒëi·ªán tho·∫°i ZaloPay (84...)</div>
            <input
              id="withdraw-phone"
              type="tel"
              class="input"
              placeholder="84xxxxxxxxx"
            />
          </div>

          <button class="btn-primary" id="withdraw-btn">
            üí∏ G·ª≠i y√™u c·∫ßu r√∫t
          </button>
          <div id="withdraw-status" class="status"></div>

          <div class="section-title" style="margin-top: 10px">
            L·ªãch s·ª≠ r√∫t g·∫ßn ƒë√¢y
          </div>
          <div id="withdraw-history" class="history-list">
            <div class="small-text">
              Ch∆∞a c√≥ y√™u c·∫ßu r√∫t n√†o. Khi b·∫°n r√∫t, l·ªãch s·ª≠ s·∫Ω hi·ªán ·ªü ƒë√¢y.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ================== PARSE QUERY ==================
      function parseQuery() {
        const params = new URLSearchParams(window.location.search);
        return {
          tg_id: params.get("tg_id") || "",
          username: params.get("username") || "",
          sig: params.get("sig") || ""
        };
      }

      const q = parseQuery();

      // ================== UI HELPERS ==================

      function setUserLabel() {
        const el = document.getElementById("user-label");
        if (!q.tg_id) {
          el.textContent =
            "Kh√¥ng t√¨m th·∫•y Telegram ID. Vui l√≤ng m·ªü t·ª´ n√∫t trong bot.";
          return;
        }
        el.textContent = `@${q.username || "user"} ¬∑ ID: ${q.tg_id}`;
      }

      function formatNumber(n) {
        return n.toLocaleString("vi-VN", {
          maximumFractionDigits: 2
        });
      }

      function formatTime(ts) {
        const d = new Date(ts * 1000);
        const pad = (n) => String(n).padStart(2, "0");
        return `${pad(d.getDate())}/${pad(
          d.getMonth() + 1
        )} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      // ================== STATE ==================
      const MINE_COOLDOWN_MS = 5 * 60 * 1000; // 5 ph√∫t
      const STORAGE_KEY = "oil_miner_backend_v1";

      const state = {
        rigLevel: 1,
        oil: 0,
        xu: 0,
        lastMineAt: 0,
        payoutOil: 0
      };

      // Mapping level -> ·∫£nh
      const rigImages = {
        1: "image/rig_level1.png",
        2: "image/rig_level2.png",
        3: "image/rig_level3.png",
        4: "image/rig_level4.png",
        5: "image/rig_level5.png",
        6: "image/rig_level6.png",
        7: "image/rig_level7.png",
        8: "image/rig_level8.png",
        9: "image/rig_level8.png", // t·∫°m d√πng chung
        10: "image/rig_level8.png" // t·∫°m d√πng chung
      };

      function loadPersistedCooldown() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const data = JSON.parse(raw);
          if (typeof data.lastMineAt === "number") {
            state.lastMineAt = data.lastMineAt;
          }
        } catch (e) {
          console.warn("Cannot load cooldown", e);
        }
      }

      function savePersistedCooldown() {
        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({ lastMineAt: state.lastMineAt || 0 })
          );
        } catch (e) {
          console.warn("Cannot save cooldown", e);
        }
      }

      // ================== API ==================

      async function apiGetState() {
        if (!q.tg_id) return;
        const url =
          "/api/state?tg_id=" +
          encodeURIComponent(q.tg_id) +
          "&username=" +
          encodeURIComponent(q.username || "");
        const res = await fetch(url);
        if (!res.ok) {
          console.error("L·ªói /api/state", await res.text());
          return;
        }
        const data = await res.json();
        state.rigLevel = data.rig_level;
        state.oil = data.oil;
        state.xu = data.xu;
        state.lastMineAt = data.last_mine_at_ms || 0;
        state.payoutOil = data.payout_oil || 0;

        // ƒë·ªìng b·ªô cooldown local n·∫øu tr·ªëng
        if (!state.lastMineAt) {
          const localRaw = localStorage.getItem(STORAGE_KEY);
          if (localRaw) {
            try {
              const obj = JSON.parse(localRaw);
              if (typeof obj.lastMineAt === "number") {
                state.lastMineAt = obj.lastMineAt;
              }
            } catch {}
          }
        } else {
          savePersistedCooldown();
        }
      }

      async function apiMine() {
        if (!q.tg_id) {
          alert("Kh√¥ng t√¨m th·∫•y Telegram ID, h√£y m·ªü t·ª´ bot.");
          return null;
        }
        const res = await fetch("/api/mine", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tg_id: q.tg_id,
            username: q.username
          })
        });
        if (!res.ok) {
          const txt = await res.text();
          alert("Kh√¥ng th·ªÉ khai th√°c: " + txt);
          return null;
        }
        const data = await res.json();
        state.rigLevel = data.rig_level;
        state.oil = data.oil;
        state.xu = data.xu;
        state.lastMineAt = data.last_mine_at_ms || Date.now();
        state.payoutOil = data.payout_oil || 0;
        savePersistedCooldown();
        return data;
      }

      async function apiUpgrade() {
        if (!q.tg_id) {
          alert("Kh√¥ng t√¨m th·∫•y Telegram ID, h√£y m·ªü t·ª´ bot.");
          return null;
        }
        const res = await fetch("/api/upgrade", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tg_id: q.tg_id,
            username: q.username
          })
        });
        if (!res.ok) {
          const txt = await res.text();
          alert("Kh√¥ng th·ªÉ n√¢ng c·∫•p: " + txt);
          return null;
        }
        const data = await res.json();
        state.rigLevel = data.rig_level;
        state.oil = data.oil;
        state.xu = data.xu;
        state.lastMineAt = data.last_mine_at_ms || state.lastMineAt;
        state.payoutOil = data.payout_oil || 0;
        return data;
      }

      async function apiWithdraw(amount, phone) {
        if (!q.tg_id) {
          alert("Kh√¥ng t√¨m th·∫•y Telegram ID, h√£y m·ªü t·ª´ bot.");
          return null;
        }
        const res = await fetch("/api/withdraw", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tg_id: q.tg_id,
            username: q.username,
            amount_xu: amount,
            phone: phone
          })
        });
        const data = await res.json();
        if (!res.ok) {
          const detail = data && data.detail ? data.detail : "L·ªói kh√¥ng x√°c ƒë·ªãnh";
          throw new Error(detail);
        }
        return data;
      }

      async function apiWithdrawHistory() {
        if (!q.tg_id) return [];
        const res = await fetch(
          "/api/withdraw-history?tg_id=" + encodeURIComponent(q.tg_id)
        );
        if (!res.ok) {
          console.error("L·ªói /api/withdraw-history", await res.text());
          return [];
        }
        return await res.json();
      }

      // ================== COOLDOWN ==================

      function getCooldownRemaining() {
        if (!state.lastMineAt) return 0;
        const now = Date.now();
        const end = state.lastMineAt + MINE_COOLDOWN_MS;
        return Math.max(0, end - now);
      }

      let cooldownTimer = null;

      function updateCooldownUI() {
        const remain = getCooldownRemaining();
        const label = document.getElementById("cooldown-label");
        const bar = document.getElementById("cooldown-bar");
        const btnMine = document.getElementById("btn-mine");

        if (remain <= 0) {
          label.textContent = "S·∫µn s√†ng ƒë√†o";
          bar.style.width = "0%";
          btnMine.disabled = false;
          return;
        }

        const remainSec = Math.ceil(remain / 1000);
        const min = Math.floor(remainSec / 60);
        const sec = remainSec % 60;
        label.textContent = `Cooldown: ${min}m ${sec}s`;

        const ratio = 1 - remain / MINE_COOLDOWN_MS;
        bar.style.width = Math.min(100, Math.max(0, ratio * 100)) + "%";
        btnMine.disabled = true;
      }

      function startCooldownTimer() {
        if (cooldownTimer) window.clearInterval(cooldownTimer);
        cooldownTimer = window.setInterval(updateCooldownUI, 1000);
        updateCooldownUI();
      }

      // ================== UI UPDATE ==================

      function updateHomeUI() {
        document.getElementById("home-oil").textContent = formatNumber(state.oil);
        document.getElementById("home-xu").textContent = formatNumber(state.xu);
        document.getElementById("home-rig-level").textContent =
          state.rigLevel || 1;
        document.getElementById("home-rig-yield").textContent =
          formatNumber(state.payoutOil || 0);
      }

      function updateOilUI() {
        document.getElementById("oil-rig-level").textContent =
          state.rigLevel || 1;
        document.getElementById("oil-rig-yield").textContent =
          formatNumber(state.payoutOil || 0);
        document.getElementById("oil-balance").textContent =
          formatNumber(state.oil);
        document.getElementById("oil-xu").textContent = formatNumber(state.xu);

        const img = document.getElementById("rig-image");
        const lvl = state.rigLevel || 1;
        const src = rigImages[lvl] || rigImages[1];
        img.src = src;
      }

      function updateWalletUI() {
        document.getElementById("wallet-oil").textContent =
          formatNumber(state.oil);
        document.getElementById("wallet-xu").textContent =
          formatNumber(state.xu);
      }

      function updateUIAll() {
        updateHomeUI();
        updateOilUI();
        updateWalletUI();
        updateCooldownUI();
      }

      // ================== HANDLERS ==================

      async function handleMine() {
        const remain = getCooldownRemaining();
        if (remain > 0) {
          updateCooldownUI();
          return;
        }
        const data = await apiMine();
        if (!data) return;
        updateUIAll();
        startCooldownTimer();
        const gained = data.payout_oil || state.payoutOil || 0;
        alert("ƒê√£ khai th√°c +" + formatNumber(gained) + " D·∫ßu!");
      }

      async function handleUpgrade() {
        if (state.rigLevel >= 10) {
          alert("Gi√†n khoan ƒë√£ ƒë·∫°t Lv.10 t·ªëi ƒëa.");
          return;
        }
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën n√¢ng c·∫•p gi√†n khoan?")) return;
        const data = await apiUpgrade();
        if (!data) return;
        updateUIAll();
        alert("ƒê√£ n√¢ng c·∫•p l√™n Lv." + data.rig_level + "!");
      }

      async function handleWithdraw() {
        const amountEl = document.getElementById("withdraw-amount");
        const phoneEl = document.getElementById("withdraw-phone");
        const statusEl = document.getElementById("withdraw-status");
        const btn = document.getElementById("withdraw-btn");

        const amount = parseFloat(amountEl.value || "0");
        const phone = (phoneEl.value || "").trim();

        statusEl.textContent = "";
        statusEl.className = "status";

        if (!amount || amount < 200) {
          statusEl.textContent = "Min r√∫t l√† 200 Xu.";
          statusEl.classList.add("error");
          return;
        }
        if (!phone.startsWith("84") || phone.length < 9) {
          statusEl.textContent = "S·ªë ƒëi·ªán tho·∫°i ph·∫£i d·∫°ng 84xxxxxxxxx.";
          statusEl.classList.add("error");
          return;
        }

        btn.disabled = true;
        statusEl.textContent = "ƒêang g·ª≠i y√™u c·∫ßu r√∫t...";
        try {
          const data = await apiWithdraw(amount, phone);
          statusEl.textContent =
            "ƒê√£ t·∫°o y√™u c·∫ßu #" +
            data.id +
            " ¬∑ " +
            data.amount_xu +
            " Xu ¬∑ " +
            data.phone;
          statusEl.classList.add("success");
          amountEl.value = "";
          await loadWithdrawHistory();
        } catch (err) {
          statusEl.textContent = "L·ªói: " + err.message;
          statusEl.classList.add("error");
        } finally {
          btn.disabled = false;
        }
      }

      async function loadWithdrawHistory() {
        const box = document.getElementById("withdraw-history");
        box.innerHTML =
          '<div class="small-text">ƒêang t·∫£i l·ªãch s·ª≠ r√∫t...</div>';
        const list = await apiWithdrawHistory();
        if (!Array.isArray(list) || list.length === 0) {
          box.innerHTML =
            '<div class="small-text">Ch∆∞a c√≥ y√™u c·∫ßu r√∫t n√†o.</div>';
          return;
        }

        box.innerHTML = "";
        list.forEach((item) => {
          const div = document.createElement("div");
          div.className = "history-item";

          let tagClass = "pending";
          let tagText = "Pending";
          if (item.status === "done" || item.status === "paid") {
            tagClass = "done";
            tagText = "Ho√†n t·∫•t";
          } else if (item.status === "reject" || item.status === "rejected") {
            tagClass = "reject";
            tagText = "T·ª´ ch·ªëi";
          }

          div.innerHTML = `
            <div class="history-top">
              <div><b>#${item.id}</b> ¬∑ ${item.amount_xu} Xu</div>
              <div class="tag ${tagClass}">${tagText}</div>
            </div>
            <div class="history-meta">SƒêT: ${item.phone}</div>
            <div class="history-meta">L√∫c: ${formatTime(
              item.created_at || 0
            )}</div>
          `;
          box.appendChild(div);
        });
      }

      function setupTabs() {
        const tabs = document.querySelectorAll(".nav-tab");
        const screens = document.querySelectorAll(".screen");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const target = tab.getAttribute("data-screen");
            tabs.forEach((t) => t.classList.remove("active"));
            screens.forEach((s) => s.classList.remove("active"));
            tab.classList.add("active");
            document
              .getElementById("screen-" + target)
              .classList.add("active");
          });
        });
      }

      // ================== INIT ==================
      document.addEventListener("DOMContentLoaded", async () => {
        setUserLabel();
        setupTabs();

        loadPersistedCooldown(); // l·∫•y cooldown local

        // L·∫•y state th·∫≠t t·ª´ backend
        await apiGetState();
        updateUIAll();
        startCooldownTimer();

        // G·∫Øn handler
        document
          .getElementById("btn-mine")
          .addEventListener("click", handleMine);
        document
          .getElementById("btn-upgrade")
          .addEventListener("click", handleUpgrade);
        document
          .getElementById("withdraw-btn")
          .addEventListener("click", handleWithdraw);

        // Load l·ªãch s·ª≠ r√∫t l·∫ßn ƒë·∫ßu
        await loadWithdrawHistory();
      });
    </script>
  </body>
</html>